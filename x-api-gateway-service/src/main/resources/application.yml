server:
  port: 9000
  compression:
    enabled: true
    mime-types: application/json,application/xml,text/html,text/plain,text/css,application/javascript

spring:
  application:
    name: x-api-gateway-service
  cloud:
    gateway:
      # 启用熔断
      default-filters:
        - name: CircuitBreaker
          args:
            name: defaultCircuitBreaker
            fallbackUri: forward:/fallback
      routes:
        - id: manage-service
          uri: lb://x-manage-service
          predicates:
            - Path=/manage/**
          filters:
            - name: CircuitBreaker
              args:
                name: manageServiceCircuitBreaker
                fallbackUri: forward:/fallback/manage
        - id: x-device-service
          uri: lb://x-device-access-service
          predicates:
            - Path=/device/**
        - id: x-data-sync-service
          uri: lb://x-data-sync-service
          predicates:
            - Path=/device-data/**
        - id: x-auth-service
          uri: lb://x-auth-service
          predicates:
            - Path=/auth/**
          filters:

        - id: file-service
          uri: lb://x-file-service
          predicates:
            - Path=/file/**
          filters:

            - name: AddResponseHeader
              args:
                name: X-Response-Time
                value: "N/A"
        - id: alert-service
          uri: lb://x-alert-notice-service
          predicates:
            - Path=/alert/**
          filters:

        - id: data-service
          uri: lb://x-data-collection-service
          predicates:
            - Path=/data/**
          filters:

        - id: config-service
          uri: lb://x-config-center-service
          predicates:
            - Path=/config/**
          filters:

        - id: repository-service
          uri: lb://x-repository-service
          predicates:
            - Path=/repository/**
          filters:

        - id: offline-analysis-service
          uri: lb://x-offline-analysis-service
          predicates:
            - Path=/offline-analysis/**
          filters:

        - id: realtime-analysis-service
          uri: lb://x-realtime-analysis-service
          predicates:
            - Path=/realtime-analysis/**
          filters:

        - id: task-scheduler-service
          uri: lb://x-task-scheduler-service
          predicates:
            - Path=/task/**
          filters:

        # 添加默认路由，处理API网关内部的API请求
        - id: api-gateway-internal
          uri: lb://x-api-gateway-service
          predicates:
            - Path=/api-gateway/api/**
          filters:

    # 负载均衡配置
    loadbalancer:
      ribbon:
        enabled: false
    # Nacos服务发现配置
    nacos:
      discovery:
        server-addr: 127.0.0.1:8848
        namespace: public
        group: DEFAULT_GROUP
      config:
        # 配置中心地址
        server-addr: 127.0.0.1:8848
        # 配置文件格式
        file-extension: yml
  # Redis配置
  data:
    redis:
      host: localhost
      port: 6379
      database: 0
      timeout: 2000ms

# 熔断器配置
resilience4j:
  circuitbreaker:
    instances:
      defaultCircuitBreaker:
        slidingWindowSize: 10
        failureRateThreshold: 50
        waitDurationInOpenState: 5000
        permittedNumberOfCallsInHalfOpenState: 3
        slidingWindowType: TIME_BASED
        minimumNumberOfCalls: 5
      manageServiceCircuitBreaker:
        slidingWindowSize: 10
        failureRateThreshold: 40
        waitDurationInOpenState: 3000

# 监控配置
management:
  endpoints:
    web:
      exposure:
        include: '*'
  endpoint:
    health:
      show-details: always
    gateway:
      enabled: true
  prometheus:
    metrics:
      export:
        enabled: true

# 日志配置
logging:
  level:
    com.x.api.gateway.service: debug
    org.springframework.cloud.gateway: info