# 高性能IoT系统性能测试环境

本文档描述了用于测试X-Service系统在高负载情况下的性能环境配置。

## 架构概述

性能测试环境采用了以下高可用、高性能的架构设计：

1. **IoTDB集群** - 3节点集群提供高吞吐量的时序数据存储
2. **Kafka集群** - 3节点集群提供高吞吐量的消息传输
3. **MySQL主从复制** - 提供高可用的关系型数据存储
4. **Redis集群** - 提供高性能的缓存服务
5. **数据收集服务集群** - 3个实例提供水平扩展能力

## 部署说明

### 环境要求

- Docker 20.0+
- Docker Compose 1.29+
- 至少16GB内存
- 至少4个CPU核心

### 启动步骤

```bash
# 克隆项目代码
git clone <项目地址>
cd x-service/performance-test

# 启动所有服务
docker-compose up -d

# 查看服务状态
docker-compose ps
```

### 服务端口映射

| 服务 | 容器内端口 | 主机端口 | 说明 |
|------|------------|----------|------|
| IoTDB Node1 | 6667 | 6667 | 主节点 |
| IoTDB Node2 | 6667 | 6668 | 从节点 |
| IoTDB Node3 | 6667 | 6669 | 从节点 |
| Kafka1 | 9092 | 9092 | Kafka节点1 |
| Kafka2 | 9093 | 9093 | Kafka节点2 |
| Kafka3 | 9094 | 9094 | Kafka节点3 |
| MySQL Master | 3306 | 3306 | 主数据库 |
| MySQL Slave | 3306 | 3307 | 从数据库 |
| Redis Node1 | 6379 | 6379 | Redis节点1 |
| Redis Node2 | 6379 | 6380 | Redis节点2 |
| Redis Node3 | 6379 | 6381 | Redis节点3 |
| Data Collection 1 | 8085 | 8085 | 数据收集服务1 |
| Data Collection 2 | 8085 | 8086 | 数据收集服务2 |
| Data Collection 3 | 8085 | 8087 | 数据收集服务3 |

## 性能测试场景

### 场景1：2万台设备，每台500个点位，每秒一次数据上报

**测试配置：**
- 设备数量：20,000台
- 每台设备点位数：500个
- 数据上报频率：1次/秒
- 总数据点数：10,000,000点/秒

**预期性能指标：**
- IoTDB写入延迟：< 10ms
- 数据收集服务处理能力：> 10,000,000点/秒
- MySQL存储延迟：< 50ms
- 系统整体可用性：99.9%

### 场景2：峰值流量测试

**测试配置：**
- 设备数量：50,000台
- 每台设备点位数：500个
- 数据上报频率：1次/秒
- 总数据点数：25,000,000点/秒

## 监控和调优

### 监控指标

1. **IoTDB性能指标**
   - 写入吞吐量（点/秒）
   - 查询响应时间
   - 内存使用率
   - 磁盘IO

2. **Kafka性能指标**
   - 消息生产速率
   - 消息消费速率
   - 消息积压情况
   - Broker负载

3. **数据收集服务指标**
   - 数据处理速率
   - 内存使用情况
   - 线程池状态
   - 错误率

### 调优建议

1. **JVM调优**
   ```bash
   -Xms4g -Xmx8g
   -XX:+UseG1GC
   -XX:MaxGCPauseMillis=200
   ```

2. **IoTDB调优**
   - 增加写入线程数
   - 调整WAL缓冲区大小
   - 优化合并策略

3. **Kafka调优**
   - 增加分区数
   - 调整批处理大小
   - 优化压缩算法

## 故障处理

### 常见问题

1. **IoTDB写入性能下降**
   - 检查磁盘IO性能
   - 调整WAL配置
   - 优化数据模型

2. **Kafka消息积压**
   - 增加消费者实例
   - 调整消费者配置
   - 检查网络带宽

3. **数据收集服务处理延迟**
   - 增加线程池大小
   - 优化批量处理逻辑
   - 检查数据库连接池

## 扩展性说明

系统支持以下扩展方式：

1. **水平扩展**
   - 增加IoTDB节点
   - 增加Kafka节点
   - 增加数据收集服务实例

2. **垂直扩展**
   - 增加单节点资源配置
   - 调整JVM参数
   - 优化应用配置